<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NES Sound and Music Composer</title>
    <style>
        :root {
            --nes-primary: #209cee;
            --nes-secondary: #e76e55;
            --nes-dark: #212529;
            --nes-light: #f8f9fa;
            --nes-success: #92cc41;
            --nes-warning: #f7d51d;
            --nes-error: #e76e55;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background-color: #222;
            color: #fff;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2 {
            text-align: center;
            color: var(--nes-primary);
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel {
            border: 4px solid var(--nes-primary);
            border-radius: 4px;
            padding: 15px;
            background-color: var(--nes-dark);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            padding: 8px 16px;
            border: 3px solid #555;
            border-radius: 4px;
            background-color: var(--nes-dark);
            color: white;
            cursor: pointer;
            transition: all 0.1s;
            min-width: 100px;
            text-align: center;
        }
        
        .btn:hover {
            transform: scale(1.05);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background-color: var(--nes-primary);
            border-color: #0b7dba;
        }
        
        .btn-secondary {
            background-color: var(--nes-secondary);
            border-color: #c4594b;
        }
        
        .btn-success {
            background-color: var(--nes-success);
            border-color: #76a934;
        }
        
        .btn-play {
            background-color: var(--nes-success);
            border-color: #76a934;
        }
        
        .btn-stop {
            background-color: var(--nes-error);
            border-color: #c4594b;
        }
        
        .sound-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 2px solid #555;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .song-title {
            font-weight: bold;
            color: var(--nes-primary);
        }
        
        .song-controls {
            display: flex;
            gap: 5px;
        }
        
        .visualizer {
            height: 100px;
            width: 100%;
            background-color: #111;
            border: 3px solid #444;
            margin-top: 20px;
            position: relative;
        }
        
        .channel {
            position: absolute;
            height: 25px;
            bottom: 0;
            width: 100%;
            display: flex;
            align-items: center;
            color: #aaa;
            font-size: 12px;
            padding-left: 5px;
        }
        
        .channel-1 { bottom: 0; background-color: rgba(32, 156, 238, 0.3); }
        .channel-2 { bottom: 25px; background-color: rgba(231, 110, 85, 0.3); }
        .channel-3 { bottom: 50px; background-color: rgba(146, 204, 65, 0.3); }
        .channel-4 { bottom: 75px; background-color: rgba(247, 213, 29, 0.3); }
        
        .visualizer-bar {
            position: absolute;
            bottom: 0;
            width: 3px;
            background-color: currentColor;
            height: 0;
            transition: height 0.05s;
        }
        
        .info-panel {
            margin-top: 20px;
        }
        
        .active {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .channel-meter {
            display: inline-block;
            width: 50px;
            height: 10px;
            margin-left: 10px;
            background-color: #333;
        }
        
        .meter-fill {
            height: 100%;
            width: 0%;
            background-color: currentColor;
            transition: width 0.1s;
        }
        
        /* Status display */
        .status {
            color: var(--nes-warning);
            text-align: center;
            margin-bottom: 10px;
            font-size: 14px;
            min-height: 20px;
        }
    </style>
</head>
<body>
    <h1>NES Sound and Music Composer</h1>
    
    <div class="status" id="statusDisplay"></div>
    
    <div class="controls">
        <button id="startButton" class="btn btn-success">Start Audio Engine</button>
    </div>
    
    <div class="container">
        <div class="panel">
            <h2>Sound Effects</h2>
            <div class="sound-grid">
                <button class="btn btn-primary" data-sfx="jump">Jump</button>
                <button class="btn btn-primary" data-sfx="coin">Coin</button>
                <button class="btn btn-primary" data-sfx="powerUp">Power Up</button>
                <button class="btn btn-primary" data-sfx="powerDown">Power Down</button>
                <button class="btn btn-primary" data-sfx="explosion">Explosion</button>
                <button class="btn btn-primary" data-sfx="select">Select</button>
                <button class="btn btn-primary" data-sfx="blip">Blip</button>
                <button class="btn btn-primary" data-sfx="laser">Laser</button>
                <button class="btn btn-primary" data-sfx="extraLife">Extra Life</button>
                <button class="btn btn-primary" data-sfx="gameOver">Game Over</button>
                <button class="btn btn-primary" data-sfx="hit">Hit</button>
                <button class="btn btn-primary" data-sfx="warp">Warp</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>Music Themes</h2>
            <div class="music-list">
                <div class="song-item">
                    <div class="song-title">Overworld Theme</div>
                    <div class="song-controls">
                        <button class="btn btn-play" data-music="overworld">Play</button>
                        <button class="btn btn-stop" data-music-stop>Stop</button>
                    </div>
                </div>
                <div class="song-item">
                    <div class="song-title">Underground Theme</div>
                    <div class="song-controls">
                        <button class="btn btn-play" data-music="underground">Play</button>
                        <button class="btn btn-stop" data-music-stop>Stop</button>
                    </div>
                </div>
                <div class="song-item">
                    <div class="song-title">Boss Theme</div>
                    <div class="song-controls">
                        <button class="btn btn-play" data-music="boss">Play</button>
                        <button class="btn btn-stop" data-music-stop>Stop</button>
                    </div>
                </div>
                <div class="song-item">
                    <div class="song-title">Adventure Theme (Original)</div>
                    <div class="song-controls">
                        <button class="btn btn-play" data-music="adventure">Play</button>
                        <button class="btn btn-stop" data-music-stop>Stop</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="visualizer">
            <div class="channel channel-1">
                Square 1
                <div class="channel-meter"><div class="meter-fill" id="meter1" style="color: #209cee"></div></div>
            </div>
            <div class="channel channel-2">
                Square 2
                <div class="channel-meter"><div class="meter-fill" id="meter2" style="color: #e76e55"></div></div>
            </div>
            <div class="channel channel-3">
                Triangle
                <div class="channel-meter"><div class="meter-fill" id="meter3" style="color: #92cc41"></div></div>
            </div>
            <div class="channel channel-4">
                Noise
                <div class="channel-meter"><div class="meter-fill" id="meter4" style="color: #f7d51d"></div></div>
            </div>
        </div>
        
        <div class="panel info-panel">
            <h2>NES Audio System Info</h2>
            <p>This composer emulates the original Nintendo Entertainment System's audio processing unit (APU), which contains:</p>
            <ul>
                <li><strong>Square Wave 1 & 2:</strong> Pulse waves with 4 duty cycle options (12.5%, 25%, 50%, 75%)</li>
                <li><strong>Triangle Wave:</strong> Fixed triangle waveform for bass sounds</li>
                <li><strong>Noise Channel:</strong> Pseudo-random noise generator for percussion and effects</li>
            </ul>
            <p>The NES sound architecture has distinctive limitations such as 5 channels maximum, limited polyphony, and characteristic frequency sweeps that give it its iconic 8-bit sound.</p>
        </div>
    </div>

    <script>
        // NES Sound and Music Composer

        // Global audio variables
        let audioCtx = null;
        let masterGain = null;
        let isAudioEngineRunning = false;
        let meterUpdateIntervalId = null;
        let statusElement = document.getElementById('statusDisplay');
        let startButton = document.getElementById('startButton');
        let currentMusicSequencer = null;
        
        // Channel activity meters
        const meters = [
            document.getElementById('meter1'),
            document.getElementById('meter2'),
            document.getElementById('meter3'),
            document.getElementById('meter4')
        ];
        
        // Channel volume levels (for visualization)
        let channelLevels = [0, 0, 0, 0];
        
        // Event setup for the start button
        startButton.addEventListener('click', initAudioEngine);
        
        // Set up sound effect buttons
        document.querySelectorAll('[data-sfx]').forEach(button => {
            button.addEventListener('click', () => {
                const sfxName = button.getAttribute('data-sfx');
                playSoundEffect(sfxName);
                
                // Visual feedback
                button.classList.add('active');
                setTimeout(() => button.classList.remove('active'), 200);
            });
        });
        
        // Set up music buttons
        document.querySelectorAll('[data-music]').forEach(button => {
            button.addEventListener('click', () => {
                const musicName = button.getAttribute('data-music');
                playMusic(musicName);
                
                // Reset all active classes first
                document.querySelectorAll('[data-music]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Set this button as active
                button.classList.add('active');
            });
        });
        
        // Set up stop music buttons
        document.querySelectorAll('[data-music-stop]').forEach(button => {
            button.addEventListener('click', stopMusic);
        });
        
        // Note to frequency mapping
        const NOTE_FREQUENCIES = {
            'C0': 16.35, 'C#0': 17.32, 'D0': 18.35, 'D#0': 19.45, 'E0': 20.60, 'F0': 21.83,
            'F#0': 23.12, 'G0': 24.50, 'G#0': 25.96, 'A0': 27.50, 'A#0': 29.14, 'B0': 30.87,
            'C1': 32.70, 'C#1': 34.65, 'D1': 36.71, 'D#1': 38.89, 'E1': 41.20, 'F1': 43.65,
            'F#1': 46.25, 'G1': 49.00, 'G#1': 51.91, 'A1': 55.00, 'A#1': 58.27, 'B1': 61.74,
            'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41, 'F2': 87.31,
            'F#2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61,
            'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23,
            'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.26, 'F5': 698.46,
            'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50, 'C#6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51, 'E6': 1318.51, 'F6': 1396.91,
            'F#6': 1479.98, 'G6': 1567.98, 'G#6': 1661.22, 'A6': 1760.00, 'A#6': 1864.66, 'B6': 1975.53,
            'C7': 2093.00, 'C#7': 2217.46, 'D7': 2349.32, 'D#7': 2489.02, 'E7': 2637.02, 'F7': 2793.83,
            'F#7': 2959.96, 'G7': 3135.96, 'G#7': 3322.44, 'A7': 3520.00, 'A#7': 3729.31, 'B7': 3951.07,
            'C8': 4186.01, 'C#8': 4434.92, 'D8': 4698.64, 'D#8': 4978.03, 'E8': 5274.04, 'F8': 5587.65,
            'F#8': 5919.91, 'G8': 6271.93, 'G#8': 6644.88, 'A8': 7040.00, 'A#8': 7458.62, 'B8': 7902.13,
            'R': 0 // Rest (silence)
        };
        
        // Initialize the audio engine
        function initAudioEngine() {
            if (isAudioEngineRunning) return;
            
            try {
                // Create audio context
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create master gain node
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.5;
                masterGain.connect(audioCtx.destination);
                
                // Start meter updates
                if (meterUpdateIntervalId) clearInterval(meterUpdateIntervalId);
                meterUpdateIntervalId = setInterval(updateMeters, 50);
                
                isAudioEngineRunning = true;
                updateStatus('Audio engine started successfully!');
                startButton.textContent = 'Audio Engine Running';
                startButton.classList.add('active');
                
                // Resume audio context if it's suspended
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        updateStatus('Audio context resumed');
                    }).catch(err => {
                        updateStatus('Failed to resume audio context: ' + err.message);
                    });
                }
                
                // Add visibility change listener
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                console.log('Audio engine initialized with state:', audioCtx.state);
            } catch (err) {
                updateStatus('Failed to start audio engine: ' + err.message);
                console.error('Audio initialization error:', err);
            }
        }
        
        // Handle page visibility changes
        function handleVisibilityChange() {
            if (!audioCtx) return;
            
            if (document.hidden) {
                updateStatus('Page hidden - audio paused');
            } else {
                // Try to resume when page becomes visible
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        updateStatus('Audio resumed after page visibility change');
                    }).catch(err => {
                        updateStatus('Failed to resume audio: ' + err.message);
                    });
                }
            }
        }
        
        // Update status display
        function updateStatus(message) {
            if (statusElement) {
                statusElement.textContent = message;
                console.log('Status:', message);
            }
        }
        
        // Update visual meters
        function updateMeters() {
            for (let i = 0; i < 4; i++) {
                // Apply decay
                channelLevels[i] = Math.max(0, channelLevels[i] - 0.05);
                meters[i].style.width = (channelLevels[i] * 100) + '%';
            }
        }
        
        // Set channel activity level
        function setChannelLevel(channel, level) {
            if (channel >= 0 && channel < 4) {
                channelLevels[channel] = Math.min(1, level);
            }
        }
        
        // Create a square wave oscillator (for NES Square/Pulse channels)
        function createSquareOscillator(options = {}) {
            if (!audioCtx) return null;
            
            const defaults = {
                frequency: 440,
                dutyCycle: 0.5,
                startTime: audioCtx.currentTime,
                stopTime: audioCtx.currentTime + 0.5,
                volume: 0.5
            };
            
            const opts = {...defaults, ...options};
            
            try {
                // Create oscillator
                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'square';
                oscillator.frequency.value = opts.frequency;
                
                // Create gain node for volume
                const gainNode = audioCtx.createGain();
                gainNode.gain.value = 0; // Start silent
                
                // Connect nodes
                oscillator.connect(gainNode);
                gainNode.connect(masterGain);
                
                // Schedule start
                oscillator.start(opts.startTime);
                
                // Apply envelope
                const envelope = {
                    attack: opts.attack || 0.01,
                    decay: opts.decay || 0.1,
                    sustain: opts.sustain || 0.7,
                    release: opts.release || 0.1
                };
                
                // Calculate timings
                const attackEndTime = opts.startTime + envelope.attack;
                const decayEndTime = attackEndTime + envelope.decay;
                const releaseStartTime = opts.stopTime - envelope.release;
                
                // Schedule volume changes for ADSR envelope
                gainNode.gain.setValueAtTime(0, opts.startTime);
                gainNode.gain.linearRampToValueAtTime(opts.volume, attackEndTime);
                gainNode.gain.linearRampToValueAtTime(opts.volume * envelope.sustain, decayEndTime);
                gainNode.gain.setValueAtTime(opts.volume * envelope.sustain, releaseStartTime);
                gainNode.gain.linearRampToValueAtTime(0, opts.stopTime);
                
                // Schedule frequency sweep if needed
                if (opts.sweep) {
                    oscillator.frequency.setValueAtTime(opts.frequency, opts.startTime);
                    oscillator.frequency.linearRampToValueAtTime(
                        opts.sweep.endFrequency,
                        opts.startTime + (opts.sweep.duration || (opts.stopTime - opts.startTime))
                    );
                }
                
                // Schedule stop
                oscillator.stop(opts.stopTime + 0.1); // Small buffer after release
                
                return {
                    oscillator: oscillator,
                    gain: gainNode,
                    stop: function(time) {
                        const now = time || audioCtx.currentTime;
                        try {
                            gainNode.gain.cancelScheduledValues(now);
                            gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                            gainNode.gain.linearRampToValueAtTime(0, now + 0.05);
                            oscillator.stop(now + 0.1);
                        } catch (e) {
                            console.error('Error stopping oscillator:', e);
                        }
                    }
                };
            } catch (err) {
                console.error('Error creating square oscillator:', err);
                return null;
            }
        }
        
        // Create a triangle wave oscillator (for NES Triangle channel)
        function createTriangleOscillator(options = {}) {
            if (!audioCtx) return null;
            
            const defaults = {
                frequency: 220,
                startTime: audioCtx.currentTime,
                stopTime: audioCtx.currentTime + 0.5,
                volume: 0.5
            };
            
            const opts = {...defaults, ...options};
            
            try {
                // Create oscillator
                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'triangle';
                oscillator.frequency.value = opts.frequency;
                
                // Create gain node for volume
                const gainNode = audioCtx.createGain();
                gainNode.gain.value = 0; // Start silent
                
                // Connect nodes
                oscillator.connect(gainNode);
                gainNode.connect(masterGain);
                
                // Schedule start
                oscillator.start(opts.startTime);
                
                // Apply envelope
                const envelope = {
                    attack: opts.attack || 0.01,
                    decay: opts.decay || 0.1,
                    sustain: opts.sustain || 0.8,
                    release: opts.release || 0.1
                };
                
                // Calculate timings
                const attackEndTime = opts.startTime + envelope.attack;
                const decayEndTime = attackEndTime + envelope.decay;
                const releaseStartTime = opts.stopTime - envelope.release;
                
                // Schedule volume changes for ADSR envelope
                gainNode.gain.setValueAtTime(0, opts.startTime);
                gainNode.gain.linearRampToValueAtTime(opts.volume, attackEndTime);
                gainNode.gain.linearRampToValueAtTime(opts.volume * envelope.sustain, decayEndTime);
                gainNode.gain.setValueAtTime(opts.volume * envelope.sustain, releaseStartTime);
                gainNode.gain.linearRampToValueAtTime(0, opts.stopTime);
                
                // Schedule frequency sweep if needed
                if (opts.sweep) {
                    oscillator.frequency.setValueAtTime(opts.frequency, opts.startTime);
                    oscillator.frequency.linearRampToValueAtTime(
                        opts.sweep.endFrequency,
                        opts.startTime + (opts.sweep.duration || (opts.stopTime - opts.startTime))
                    );
                }
                
                // Schedule stop
                oscillator.stop(opts.stopTime + 0.1); // Small buffer after release
                
                return {
                    oscillator: oscillator,
                    gain: gainNode,
                    stop: function(time) {
                        const now = time || audioCtx.currentTime;
                        try {
                            gainNode.gain.cancelScheduledValues(now);
                            gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                            gainNode.gain.linearRampToValueAtTime(0, now + 0.05);
                            oscillator.stop(now + 0.1);
                        } catch (e) {
                            console.error('Error stopping oscillator:', e);
                        }
                    }
                };
            } catch (err) {
                console.error('Error creating triangle oscillator:', err);
                return null;
            }
        }
        
        // Create a noise generator (for NES Noise channel)
        function createNoiseGenerator(options = {}) {
            if (!audioCtx) return null;
            
            const defaults = {
                frequency: 500, // Controls filter frequency for noise tone
                startTime: audioCtx.currentTime,
                stopTime: audioCtx.currentTime + 0.5,
                volume: 0.5,
                metallic: false // NES had "metallic" and regular noise modes
            };
            
            const opts = {...defaults, ...options};
            
            try {
                // Create buffer for noise
                const bufferSize = audioCtx.sampleRate;
                const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const outputData = noiseBuffer.getChannelData(0);
                
                // Fill buffer with noise
                if (opts.metallic) {
                    // "Metallic" noise has a more regular pattern
                    let shiftRegister = 1;
                    for (let i = 0; i < bufferSize; i++) {
                        // Simulate hardware shift register
                        const bit0 = shiftRegister & 1;
                        const bit1 = (shiftRegister >> 1) & 1;
                        const newBit = bit0 ^ bit1;
                        shiftRegister = (shiftRegister >> 1) | (newBit << 14);
                        outputData[i] = (shiftRegister & 1) * 2 - 1;
                    }
                } else {
                    // Regular random noise
                    for (let i = 0; i < bufferSize; i++) {
                        outputData[i] = Math.random() * 2 - 1;
                    }
                }
                
                // Create source from buffer
                const noiseSource = audioCtx.createBufferSource();
                noiseSource.buffer = noiseBuffer;
                noiseSource.loop = true;
                
                // Create filter to shape noise and give it "tone"
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = opts.frequency;
                filter.Q.value = 1.0;
                
                // Create gain node for volume
                const gainNode = audioCtx.createGain();
                gainNode.gain.value = 0; // Start silent
                
                // Connect nodes
                noiseSource.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(masterGain);
                
                // Schedule start
                noiseSource.start(opts.startTime);
                
                // Apply envelope
                const envelope = {
                    attack: opts.attack || 0.01,
                    decay: opts.decay || 0.1,
                    sustain: opts.sustain || 0.5,
                    release: opts.release || 0.1
                };
                
                // Calculate timings
                const attackEndTime = opts.startTime + envelope.attack;
                const decayEndTime = attackEndTime + envelope.decay;
                const releaseStartTime = opts.stopTime - envelope.release;
                
                // Schedule volume changes for ADSR envelope
                gainNode.gain.setValueAtTime(0, opts.startTime);
                gainNode.gain.linearRampToValueAtTime(opts.volume, attackEndTime);
                gainNode.gain.linearRampToValueAtTime(opts.volume * envelope.sustain, decayEndTime);
                gainNode.gain.setValueAtTime(opts.volume * envelope.sustain, releaseStartTime);
                gainNode.gain.linearRampToValueAtTime(0, opts.stopTime);
                
                // Schedule stop
                noiseSource.stop(opts.stopTime + 0.1); // Small buffer after release
                
                return {
                    source: noiseSource,
                    filter: filter,
                    gain: gainNode,
                    stop: function(time) {
                        const now = time || audioCtx.currentTime;
                        try {
                            gainNode.gain.cancelScheduledValues(now);
                            gainNode.gain.setValueAtTime(gainNode.gain.value, now);
                            gainNode.gain.linearRampToValueAtTime(0, now + 0.05);
                            noiseSource.stop(now + 0.1);
                        } catch (e) {
                            console.error('Error stopping noise generator:', e);
                        }
                    }
                };
            } catch (err) {
                console.error('Error creating noise generator:', err);
                return null;
            }
        }
        
        // Sound effect player
        function playSoundEffect(name) {
            if (!isAudioEngineRunning) {
                initAudioEngine();
                updateStatus('Initializing audio for sound effect...');
                // Try again after a small delay
                setTimeout(() => {
                    if (isAudioEngineRunning) playSoundEffect(name);
                }, 100);
                return;
            }
            
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    playSoundEffect(name);
                }).catch(err => {
                    updateStatus('Failed to resume audio for sound effect: ' + err.message);
                });
                return;
            }
            
            // Use the sound effect definitions
            try {
                const effectFn = soundEffects[name];
                if (effectFn && typeof effectFn === 'function') {
                    updateStatus('Playing sound effect: ' + name);
                    effectFn();
                } else {
                    updateStatus('Sound effect not found: ' + name);
                }
            } catch (err) {
                updateStatus('Error playing sound effect: ' + err.message);
                console.error('Sound effect error:', err);
            }
        }
        
        // Sound effect definitions
        const soundEffects = {
            // Jump sound
            jump: function() {
                const now = audioCtx.currentTime;
                const duration = 0.3;
                
                const square = createSquareOscillator({
                    frequency: 380,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.7,
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.4,
                    release: 0.1,
                    sweep: {
                        endFrequency: 600,
                        duration: duration
                    }
                });
                
                setChannelLevel(0, 0.8); // Visual feedback
            },
            
            // Coin sound
            coin: function() {
                const now = audioCtx.currentTime;
                const duration = 0.3;
                
                const square1 = createSquareOscillator({
                    frequency: 988,
                    startTime: now,
                    stopTime: now + duration * 0.5,
                    volume: 0.7,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.6,
                    release: 0.1
                });
                
                const square2 = createSquareOscillator({
                    frequency: 1318.5,
                    startTime: now + 0.08,
                    stopTime: now + duration,
                    volume: 0.7,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.6,
                    release: 0.1
                });
                
                setChannelLevel(0, 0.7); // Visual feedback
                setChannelLevel(1, 0.7); // Visual feedback
            },
            
            // Power-up sound
            powerUp: function() {
                const now = audioCtx.currentTime;
                const duration = 0.8;
                
                const square1 = createSquareOscillator({
                    frequency: 523.25,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.7,
                    attack: 0.05,
                    decay: 0.2,
                    sustain: 0.5,
                    release: 0.2,
                    sweep: {
                        endFrequency: 1046.5,
                        duration: duration
                    }
                });
                
                const square2 = createSquareOscillator({
                    frequency: 659.26,
                    startTime: now + 0.05,
                    stopTime: now + duration,
                    volume: 0.5,
                    attack: 0.05,
                    decay: 0.2,
                    sustain: 0.4,
                    release: 0.2
                });
                
                setChannelLevel(0, 0.7); // Visual feedback
                setChannelLevel(1, 0.5); // Visual feedback
            },
            
            // Power-down sound
            powerDown: function() {
                const now = audioCtx.currentTime;
                const duration = 0.6;
                
                const square1 = createSquareOscillator({
                    frequency: 493.88,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.7,
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.5,
                    release: 0.2,
                    sweep: {
                        endFrequency: 246.94,
                        duration: duration
                    }
                });
                
                const square2 = createSquareOscillator({
                    frequency: 369.99,
                    startTime: now + 0.05,
                    stopTime: now + duration,
                    volume: 0.5,
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.4,
                    release: 0.2
                });
                
                setChannelLevel(0, 0.7); // Visual feedback
                setChannelLevel(1, 0.5); // Visual feedback
            },
            
            // Explosion sound
            explosion: function() {
                const now = audioCtx.currentTime;
                const duration = 0.5;
                
                const noise = createNoiseGenerator({
                    frequency: 400,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 1.0,
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.3,
                    metallic: false
                });
                
                const square = createSquareOscillator({
                    frequency: 150,
                    startTime: now,
                    stopTime: now + duration * 0.4,
                    volume: 0.6,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.1,
                    release: 0.2,
                    sweep: {
                        endFrequency: 40,
                        duration: duration * 0.4
                    }
                });
                
                setChannelLevel(0, 0.6); // Visual feedback
                setChannelLevel(3, 1.0); // Visual feedback
            },
            
            // Menu select sound
            select: function() {
                const now = audioCtx.currentTime;
                const duration = 0.15;
                
                const square = createSquareOscillator({
                    frequency: 659.26,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.5,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.5,
                    release: 0.05
                });
                
                setChannelLevel(0, 0.5); // Visual feedback
            },
            
            // Short blip sound
            blip: function() {
                const now = audioCtx.currentTime;
                const duration = 0.15;
                
                const square = createSquareOscillator({
                    frequency: 440,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.6,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.5,
                    release: 0.05
                });
                
                setChannelLevel(0, 0.6); // Visual feedback
            },
            
            // Laser sound
            laser: function() {
                const now = audioCtx.currentTime;
                const duration = 0.3;
                
                const square = createSquareOscillator({
                    frequency: 1000,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.6,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.4,
                    release: 0.1,
                    sweep: {
                        endFrequency: 500,
                        duration: duration
                    }
                });
                
                const noise = createNoiseGenerator({
                    frequency: 800,
                    startTime: now,
                    stopTime: now + duration * 0.7,
                    volume: 0.2,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.2,
                    release: 0.1,
                    metallic: true
                });
                
                setChannelLevel(0, 0.6); // Visual feedback
                setChannelLevel(3, 0.2); // Visual feedback
            },
            
            // Extra life sound
            extraLife: function() {
                const now = audioCtx.currentTime;
                const duration = 0.5;
                
                const square1 = createSquareOscillator({
                    frequency: 493.88,
                    startTime: now,
                    stopTime: now + duration * 0.3,
                    volume: 0.7,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.6,
                    release: 0.1
                });
                
                const square2 = createSquareOscillator({
                    frequency: 659.26,
                    startTime: now + 0.08,
                    stopTime: now + duration * 0.6,
                    volume: 0.7,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.6,
                    release: 0.1
                });
                
                const triangle = createTriangleOscillator({
                    frequency: 783.99,
                    startTime: now + 0.16,
                    stopTime: now + duration,
                    volume: 0.7,
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.6,
                    release: 0.1
                });
                
                setChannelLevel(0, 0.7); // Visual feedback
                setChannelLevel(1, 0.7); // Visual feedback
                setChannelLevel(2, 0.7); // Visual feedback
            },
            
            // Game over sound
            gameOver: function() {
                const now = audioCtx.currentTime;
                const duration = 1.5;
                
                const square1 = createSquareOscillator({
                    frequency: 493.88,
                    startTime: now,
                    stopTime: now + duration * 0.7,
                    volume: 0.7,
                    attack: 0.05,
                    decay: 0.3,
                    sustain: 0.6,
                    release: 0.4
                });
                
                const square2 = createSquareOscillator({
                    frequency: 369.99,
                    startTime: now + 0.1,
                    stopTime: now + duration * 0.8,
                    volume: 0.6,
                    attack: 0.05,
                    decay: 0.3,
                    sustain: 0.5,
                    release: 0.4
                });
                
                const triangle = createTriangleOscillator({
                    frequency: 293.67,
                    startTime: now + 0.4,
                    stopTime: now + duration,
                    volume: 0.8,
                    attack: 0.05,
                    decay: 0.4,
                    sustain: 0.4,
                    release: 0.5
                });
                
                setChannelLevel(0, 0.7); // Visual feedback
                setChannelLevel(1, 0.6); // Visual feedback
                setChannelLevel(2, 0.8); // Visual feedback
            },
            
            // Hit/damage sound
            hit: function() {
                const now = audioCtx.currentTime;
                const duration = 0.3;
                
                const noise = createNoiseGenerator({
                    frequency: 600,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.6,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.2,
                    release: 0.1
                });
                
                const square = createSquareOscillator({
                    frequency: 196,
                    startTime: now,
                    stopTime: now + duration * 0.7,
                    volume: 0.5,
                    attack: 0.01,
                    decay: 0.05,
                    sustain: 0.1,
                    release: 0.1
                });
                
                setChannelLevel(0, 0.5); // Visual feedback
                setChannelLevel(3, 0.6); // Visual feedback
            },
            
            // Warp/teleport sound
            warp: function() {
                const now = audioCtx.currentTime;
                const duration = 0.7;
                
                const square1 = createSquareOscillator({
                    frequency: 120,
                    startTime: now,
                    stopTime: now + duration,
                    volume: 0.6,
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.5,
                    release: 0.1,
                    sweep: {
                        endFrequency: 1200,
                        duration: duration
                    }
                });
                
                const square2 = createSquareOscillator({
                    frequency: 140,
                    startTime: now + 0.05,
                    stopTime: now + duration,
                    volume: 0.4,
                    attack: 0.05,
                    decay: 0.1,
                    sustain: 0.4,
                    release: 0.1,
                    sweep: {
                        endFrequency: 1400,
                        duration: duration
                    }
                });
                
                setChannelLevel(0, 0.6); // Visual feedback
                setChannelLevel(1, 0.4); // Visual feedback
            }
        };

        // Define music patterns
        const musicPatterns = {
            // Overworld theme (Super Mario Bros. inspired)
            overworld: {
                name: "Overworld Theme",
                tempo: 320,
                tracks: {
                    square1: {
                        // Melody line
                        duty: 0.5,
                        volume: 0.7,
                        noteLength: 0.85,
                        notes: [
                            'E5', 'E5', 'R', 'E5', 'R', 'C5', 'E5', 'R', 
                            'G5', 'R', 'R', 'R', 'G4', 'R', 'R', 'R',
                            'C5', 'R', 'R', 'G4', 'R', 'R', 'E4', 'R', 
                            'R', 'A4', 'R', 'B4', 'R', 'A#4', 'A4', 'R',
                            'G4', 'E5', 'G5', 'A5', 'R', 'F5', 'G5', 'R', 
                            'E5', 'R', 'C5', 'D5', 'B4', 'R', 'R', 'R'
                        ]
                    },
                    square2: {
                        // Accompaniment
                        duty: 0.25,
                        volume: 0.4,
                        noteLength: 0.85,
                        notes: [
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'C4', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'G3', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'E3', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'C4', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'G3', 'R', 'R', 'R', 'R', 'R', 'R', 'R'
                        ]
                    },
                    triangle: {
                        // Bass line
                        volume: 0.8,
                        noteLength: 0.9,
                        notes: [
                            'C3', 'R', 'R', 'C3', 'R', 'R', 'C3', 'R',
                            'G2', 'R', 'R', 'G2', 'R', 'R', 'G2', 'R',
                            'E2', 'R', 'R', 'E2', 'R', 'R', 'E2', 'R',
                            'A2', 'R', 'R', 'A2', 'R', 'R', 'A2', 'R',
                            'F2', 'R', 'R', 'F2', 'R', 'R', 'F2', 'R',
                            'G2', 'R', 'R', 'G2', 'R', 'R', 'G2', 'R'
                        ]
                    },
                    noise: {
                        // Percussion
                        volume: 0.3,
                        metallic: false,
                        noteLength: 0.5,
                        notes: [
                            'R', 'R', 'A3', 'R', 'R', 'A3', 'R', 'R',
                            'A3', 'R', 'A3', 'R', 'A3', 'R', 'R', 'R',
                            'R', 'R', 'A3', 'R', 'R', 'A3', 'R', 'R',
                            'A3', 'R', 'A3', 'R', 'A3', 'R', 'R', 'R',
                            'R', 'R', 'A3', 'R', 'R', 'A3', 'R', 'R',
                            'A3', 'R', 'A3', 'R', 'A3', 'R', 'R', 'R'
                        ]
                    }
                }
            },
            
            // Underground theme (mystical/cave inspired)
            underground: {
                name: "Underground Theme",
                tempo: 240,
                tracks: {
                    square1: {
                        // Main melody
                        duty: 0.5,
                        volume: 0.6,
                        noteLength: 0.9,
                        notes: [
                            'C4', 'C5', 'A3', 'A4', 'A#3', 'A#4', 'R', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'C4', 'C5', 'A3', 'A4', 'A#3', 'A#4', 'R', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'F3', 'F4', 'D3', 'D4', 'D#3', 'D#4', 'R', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'F3', 'F4', 'D3', 'D4', 'D#3', 'D#4', 'R', 'D#4',
                            'D4', 'C4', 'R', 'R', 'R', 'R', 'R', 'R'
                        ]
                    },
                    square2: {
                        // Echo/harmony
                        duty: 0.25,
                        volume: 0.4,
                        noteLength: 0.8,
                        notes: [
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'C4', 'C5', 'A3', 'A4', 'A#3', 'A#4', 'R', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'C4', 'C5', 'A3', 'A4', 'A#3', 'A#4', 'R', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'F3', 'F4', 'D3', 'D4', 'D#3', 'D#4', 'R', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'R', 'R',
                            'R', 'R', 'R', 'R', 'D#3', 'D#4', 'D3', 'D4'
                        ]
                    },
                    triangle: {
                        // Bass
                        volume: 0.8,
                        noteLength: 0.9,
                        notes: [
                            'C2', 'R', 'R', 'R', 'R', 'R', 'A#1', 'R',
                            'A1', 'R', 'R', 'R', 'R', 'R', 'G1', 'R',
                            'C2', 'R', 'R', 'R', 'R', 'R', 'A#1', 'R',
                            'A1', 'R', 'R', 'R', 'R', 'R', 'G1', 'R',
                            'F1', 'R', 'R', 'R', 'R', 'R', 'D#1', 'R',
                            'D1', 'R', 'R', 'R', 'R', 'R', 'C1', 'R',
                            'F1', 'R', 'R', 'R', 'R', 'R', 'D#1', 'R',
                            'D1', 'R', 'R', 'R', 'C1', 'R', 'R', 'R'
                        ]
                    },
                    noise: {
                        // Sparse percussion
                        volume: 0.2,
                        metallic: true,
                        noteLength: 0.3,
                        notes: [
                            'R', 'R', 'R', 'R', 'R', 'R', 'A3', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'A3', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'A3', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'A3', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'A3', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'A3', 'R',
                            'R', 'R', 'R', 'R', 'R', 'R', 'A3', 'R',
                            'A3', 'R', 'A3', 'R', 'A3', 'R', 'A3', 'R'
                        ]
                    }
                }
            },
            
            // Boss theme (intense battle music)
            boss: {
                name: "Boss Theme",
                tempo: 300,
                tracks: {
                    square1: {
                        // Main lead
                        duty: 0.125,
                        volume: 0.7,
                        noteLength: 0.8,
                        notes: [
                            'C5', 'C5', 'C5', 'R', 'G4', 'G4', 'G4', 'R',
                            'C5', 'C5', 'C5', 'R', 'G4', 'G4', 'G4', 'R',
                            'A#4', 'A#4', 'A#4', 'R', 'F4', 'F4', 'F4', 'R',
                            'A#4', 'A#4', 'A#4', 'R', 'D#5', 'D5', 'C5', 'R',
                            'C5', 'C5', 'C5', 'R', 'G4', 'G4', 'G4', 'R',
                            'C5', 'C5', 'C5', 'R', 'G4', 'G4', 'G4', 'R',
                            'A#4', 'A#4', 'A#4', 'R', 'F4', 'F4', 'F4', 'R',
                            'A#4', 'A#4', 'A#4', 'R', 'D#5', 'D5', 'C5', 'R'
                        ]
                    },
                    square2: {
                        // Harmony
                        duty: 0.5,
                        volume: 0.4,
                        noteLength: 0.7,
                        notes: [
                            'G4', 'G4', 'G4', 'R', 'D#4', 'D#4', 'D#4', 'R',
                            'G4', 'G4', 'G4', 'R', 'D#4', 'D#4', 'D#4', 'R',
                            'F4', 'F4', 'F4', 'R', 'C4', 'C4', 'C4', 'R',
                            'F4', 'F4', 'F4', 'R', 'G#4', 'G4', 'F4', 'R',
                            'G4', 'G4', 'G4', 'R', 'D#4', 'D#4', 'D#4', 'R',
                            'G4', 'G4', 'G4', 'R', 'D#4', 'D#4', 'D#4', 'R',
                            'F4', 'F4', 'F4', 'R', 'C4', 'C4', 'C4', 'R',
                            'F4', 'F4', 'F4', 'R', 'G#4', 'G4', 'F4', 'R'
                        ]
                    },
                    triangle: {
                        // Bassline
                        volume: 0.8,
                        noteLength: 0.9,
                        notes: [
                            'C3', 'R', 'G2', 'R', 'C3', 'R', 'G2', 'R',
                            'C3', 'R', 'G2', 'R', 'C3', 'R', 'G2', 'R',
                            'A#2', 'R', 'F2', 'R', 'A#2', 'R', 'F2', 'R',
                            'A#2', 'R', 'F2', 'R', 'A#2', 'R', 'D#2', 'R',
                            'C3', 'R', 'G2', 'R', 'C3', 'R', 'G2', 'R',
                            'C3', 'R', 'G2', 'R', 'C3', 'R', 'G2', 'R',
                            'A#2', 'R', 'F2', 'R', 'A#2', 'R', 'F2', 'R',
                            'A#2', 'R', 'F2', 'R', 'A#2', 'R', 'D#2', 'R'
                        ]
                    },
                    noise: {
                        // Intense percussion
                        volume: 0.5,
                        metallic: false,
                        noteLength: 0.5,
                        notes: [
                            'A3', 'R', 'A3', 'A3', 'A3', 'R', 'A3', 'A3',
                            'A3', 'R', 'A3', 'A3', 'A3', 'R', 'A3', 'A3',
                            'A3', 'R', 'A3', 'A3', 'A3', 'R', 'A3', 'A3',
                            'A3', 'A3', 'A3', 'A3', 'A3', 'A3', 'A3', 'A3',
                            'A3', 'R', 'A3', 'A3', 'A3', 'R', 'A3', 'A3',
                            'A3', 'R', 'A3', 'A3', 'A3', 'R', 'A3', 'A3',
                            'A3', 'R', 'A3', 'A3', 'A3', 'R', 'A3', 'A3',
                            'A3', 'A3', 'A3', 'A3', 'A3', 'A3', 'A3', 'A3'
                        ]
                    }
                }
            },
            
            // Adventure theme (original composition)
            adventure: {
                name: "Adventure Theme",
                tempo: 170,
                tracks: {
                    square1: {
                        // Main melody
                        duty: 0.5,
                        volume: 0.7,
                        noteLength: 0.85,
                        notes: [
                            'E4', 'G4', 'A4', 'C5', 'A4', 'G4', 'E4', 'G4',
                            'A4', 'C5', 'D5', 'E5', 'G5', 'E5', 'D5', 'C5',
                            'A4', 'G4', 'E4', 'G4', 'A4', 'C5', 'A4', 'G4',
                            'E4', 'D4', 'E4', 'G4', 'A4', 'R', 'R', 'R',
                            'D5', 'E5', 'G5', 'A5', 'G5', 'E5', 'D5', 'E5',
                            'C5', 'A4', 'G4', 'E4', 'G4', 'A4', 'G4', 'E4',
                            'D4', 'E4', 'G4', 'A4', 'C5', 'A4', 'G4', 'E4',
                            'D4', 'C4', 'D4', 'E4', 'D4', 'C4', 'A3', 'R'
                        ]
                    },
                    square2: {
                        // Harmony and countermelody
                        duty: 0.25,
                        volume: 0.4,
                        noteLength: 0.7,
                        notes: [
                            'C4', 'R', 'E4', 'R', 'C4', 'R', 'E4', 'R',
                            'F4', 'R', 'A4', 'R', 'F4', 'R', 'A4', 'R',
                            'C4', 'R', 'E4', 'R', 'C4', 'R', 'E4', 'R',
                            'G3', 'R', 'B3', 'R', 'D4', 'R', 'G3', 'R',
                            'G4', 'R', 'B4', 'R', 'G4', 'R', 'B4', 'R',
                            'A4', 'R', 'C5', 'R', 'A4', 'R', 'E4', 'R',
                            'F4', 'R', 'A4', 'R', 'F4', 'R', 'A4', 'R',
                            'G3', 'R', 'B3', 'R', 'G3', 'R', 'D4', 'R'
                        ]
                    },
                    triangle: {
                        // Bass line
                        volume: 0.8,
                        noteLength: 0.9,
                        notes: [
                            'A2', 'R', 'E3', 'R', 'A2', 'R', 'E3', 'R',
                            'F2', 'R', 'C3', 'R', 'F2', 'R', 'C3', 'R',
                            'A2', 'R', 'E3', 'R', 'A2', 'R', 'E3', 'R',
                            'G2', 'R', 'D3', 'R', 'G2', 'R', 'D3', 'R',
                            'G2', 'R', 'D3', 'R', 'G2', 'R', 'D3', 'R',
                            'A2', 'R', 'E3', 'R', 'A2', 'R', 'E3', 'R',
                            'F2', 'R', 'C3', 'R', 'F2', 'R', 'C3', 'R',
                            'G2', 'R', 'D3', 'R', 'G2', 'R', 'D3', 'R'
                        ]
                    },
                    noise: {
                        // Percussion
                        volume: 0.4,
                        metallic: false,
                        noteLength: 0.4,
                        notes: [
                            'A3', 'R', 'A3', 'R', 'A3', 'A3', 'A3', 'R',
                            'A3', 'R', 'A3', 'R', 'A3', 'A3', 'A3', 'A3',
                            'A3', 'R', 'A3', 'R', 'A3', 'A3', 'A3', 'R',
                            'A3', 'R', 'A3', 'A3', 'A3', 'A3', 'A3', 'A3',
                            'A3', 'R', 'A3', 'R', 'A3', 'A3', 'A3', 'R',
                            'A3', 'R', 'A3', 'R', 'A3', 'A3', 'A3', 'A3',
                            'A3', 'R', 'A3', 'R', 'A3', 'A3', 'A3', 'R',
                            'A3', 'A3', 'A3', 'A3', 'A3', 'A3', 'A3', 'A3'
                        ]
                    }
                }
            }
        };
        
        // Simple music sequencer class
        class MusicSequencer {
            constructor(audioContext, masterGainNode) {
                this.audioCtx = audioContext;
                this.masterGain = masterGainNode;
                this.isPlaying = false;
                this.currentPattern = null;
                this.activeNotes = [];
                this.patternTimeout = null;
                this.loopInterval = null;
                this.currentStep = 0;
                this.tempo = 120; // BPM
            }
            
            // Start playing a pattern
            play(pattern) {
                if (this.isPlaying) {
                    this.stop();
                }
                
                this.currentPattern = pattern;
                this.tempo = pattern.tempo || 120;
                this.isPlaying = true;
                this.currentStep = 0;
                
                // Calculate step time in ms
                const stepTime = (60 / this.tempo) * 1000;
                
                // Play the pattern
                this.playStep();
                
                // Set up the loop
                this.loopInterval = setInterval(() => {
                    this.currentStep = (this.currentStep + 1) % 48; // Assuming 48 steps per pattern
                    this.playStep();
                }, stepTime);
                
                updateStatus(`Playing music: ${pattern.name || 'Unknown'} at ${this.tempo} BPM`);
            }
            
            // Play a single step of the pattern
            playStep() {
                if (!this.isPlaying || !this.currentPattern) return;
                
                const pattern = this.currentPattern;
                const now = this.audioCtx.currentTime;
                
                // Process each track
                Object.entries(pattern.tracks).forEach(([trackName, track]) => {
                    if (!track || !track.notes) return;
                    
                    // Get the note for this step
                    const noteIndex = this.currentStep % track.notes.length;
                    const note = track.notes[noteIndex];
                    
                    if (note && note !== 'R') { // Not a rest
                        const freq = NOTE_FREQUENCIES[note] || 0;
                        if (freq <= 0) return;
                        
                        // Duration for this note (in seconds)
                        const duration = (60 / this.tempo) * (track.noteLength || 0.9);
                        
                        // Create the note based on the track type
                        let noteObj = null;
                        
                        switch (trackName) {
                            case 'square1':
                                noteObj = createSquareOscillator({
                                    frequency: freq,
                                    startTime: now,
                                    stopTime: now + duration,
                                    volume: track.volume || 0.5,
                                    attack: 0.01,
                                    decay: 0.1,
                                    sustain: 0.8,
                                    release: 0.1
                                });
                                setChannelLevel(0, track.volume || 0.5);
                                break;
                                
                            case 'square2':
                                noteObj = createSquareOscillator({
                                    frequency: freq,
                                    startTime: now,
                                    stopTime: now + duration,
                                    volume: track.volume || 0.5,
                                    attack: 0.01,
                                    decay: 0.1,
                                    sustain: 0.8,
                                    release: 0.1
                                });
                                setChannelLevel(1, track.volume || 0.5);
                                break;
                                
                            case 'triangle':
                                noteObj = createTriangleOscillator({
                                    frequency: freq,
                                    startTime: now,
                                    stopTime: now + duration,
                                    volume: track.volume || 0.8,
                                    attack: 0.01,
                                    decay: 0.1,
                                    sustain: 0.9,
                                    release: 0.05
                                });
                                setChannelLevel(2, track.volume || 0.8);
                                break;
                                
                            case 'noise':
                                noteObj = createNoiseGenerator({
                                    frequency: freq / 2, // Lower frequency for noise to simulate hardware
                                    startTime: now,
                                    stopTime: now + duration,
                                    volume: track.volume || 0.5,
                                    attack: 0.01,
                                    decay: 0.1,
                                    sustain: 0.5,
                                    release: 0.1,
                                    metallic: track.metallic || false
                                });
                                setChannelLevel(3, track.volume || 0.5);
                                break;
                        }
                        
                        if (noteObj) {
                            this.activeNotes.push(noteObj);
                            
                            // Clean up finished notes
                            this.cleanupNotes();
                        }
                    }
                });
            }
            
            // Clean up completed notes
            cleanupNotes() {
                const now = this.audioCtx.currentTime;
                const newActiveNotes = [];
                
                // Keep only notes that haven't completed
                for (let note of this.activeNotes) {
                    if (!note) continue;
                    
                    if (note.oscillator && note.oscillator.frequency && 
                        typeof note.oscillator.frequency.value === 'number') {
                        newActiveNotes.push(note);
                    }
                }
                
                this.activeNotes = newActiveNotes;
            }
            
            // Stop playing
            stop() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                
                // Clear the loop interval
                if (this.loopInterval) {
                    clearInterval(this.loopInterval);
                    this.loopInterval = null;
                }
                
                // Stop all active notes
                this.stopAllNotes();
                
                updateStatus('Music stopped');
            }
            
            // Stop all active notes
            stopAllNotes() {
                const now = this.audioCtx.currentTime;
                
                for (let note of this.activeNotes) {
                    if (note && typeof note.stop === 'function') {
                        note.stop(now);
                    }
                }
                
                this.activeNotes = [];
                
                // Reset channel meters
                for (let i = 0; i < 4; i++) {
                    channelLevels[i] = 0;
                }
            }
        }
        
        // Play music theme
        function playMusic(themeName) {
            if (!isAudioEngineRunning) {
                initAudioEngine();
                updateStatus('Initializing audio for music playback...');
                // Try again after a small delay
                setTimeout(() => {
                    if (isAudioEngineRunning) playMusic(themeName);
                }, 100);
                return;
            }
            
            // Make sure audio context is running
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    playMusic(themeName);
                }).catch(err => {
                    updateStatus('Failed to resume audio for music: ' + err.message);
                });
                return;
            }
            
            // Stop current music if playing
            stopMusic();
            
            // Debug: log all available theme names
            console.log("Available themes:", Object.keys(musicPatterns));
            updateStatus("Looking for theme: " + themeName);
            
            // Get the pattern
            const pattern = musicPatterns[themeName];
            if (!pattern) {
                updateStatus(`Music theme "${themeName}" not found. Available themes: ${Object.keys(musicPatterns).join(', ')}`);
                return;
            }
            
            // Create sequencer if needed
            if (!currentMusicSequencer) {
                currentMusicSequencer = new MusicSequencer(audioCtx, masterGain);
            }
            
            // Start playback
            currentMusicSequencer.play(pattern);
        }
        
        // Stop music playback
        function stopMusic() {
            if (currentMusicSequencer) {
                currentMusicSequencer.stop();
            }
            
            // Reset button states
            document.querySelectorAll('[data-music]').forEach(btn => {
                btn.classList.remove('active');
            });
        }
        
        // Clean up when page is unloaded
        window.addEventListener('beforeunload', () => {
            if (meterUpdateIntervalId) {
                clearInterval(meterUpdateIntervalId);
            }
            
            stopMusic();
            
            if (audioCtx) {
                audioCtx.close();
            }
        });
    </script>
</body>
</html>
